<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Eighty760's always-on CFE simulation framework whitepaper covering methodology, architecture, and performance benchmarks for real-time financial risk analysis.">
    <meta name="keywords" content="Eighty760, CFE simulation, always-on simulator, financial risk analysis, streaming analytics, Monte Carlo, digital twin">
    <meta name="author" content="Eighty760">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://eighty760.com/whitepaper">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Eighty760 Whitepaper | 24/7 CFE Simulation Framework">
    <meta property="og:description" content="Eighty760's always-on CFE simulation framework whitepaper covering methodology, architecture, and performance benchmarks for real-time financial risk analysis.">
    <meta property="og:url" content="https://eighty760.com/whitepaper">
    <meta property="og:image" content="https://eighty760.com/image.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Eighty760 Whitepaper | 24/7 CFE Simulation Framework">
    <meta name="twitter:description" content="Eighty760's always-on CFE simulation framework whitepaper covering methodology, architecture, and performance benchmarks for real-time financial risk analysis.">
    <meta name="twitter:image" content="https://eighty760.com/image.png">
    <title>Eighty760 | 24/7 CFE Simulation Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Fonts matched to app.py: Inter for UI, IBM Plex Mono for Data -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=IBM+Plex+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Exact styles from app.py Light Mode */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #FFFFFF; 
            color: #1F2937; 
        }
        
        h1, h2, h3, h4 {
            font-weight: 700;
            color: #1F2937; /* Standard dark, specific headers will get brand color */
        }

        .brand-text {
            color: #285477; /* The specific blue from app.py */
        }

        /* Metric Styling from app.py */
        .stMetric {
            background-color: #F5F5F5;
            padding: 1rem;
            border-radius: 8px;
        }
        .stMetricValue {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.875rem; /* 3rem in app, scaled for web context */
            font-weight: 700;
            color: #285477;
        }
        .stMetricLabel {
            font-size: 0.875rem;
            color: #666666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Primary Button Style from app.py */
        .btn-primary {
            background-color: #000000;
            color: #FFFFFF;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #333333;
        }

        /* Chart Container */
        .chart-container { 
            position: relative; 
            width: 100%; 
            height: 300px; 
            max-height: 400px;
        }
        
        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #285477; /* Brand Blue */
            cursor: pointer;
            margin-top: -6px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #E5E7EB;
            border-radius: 2px;
        }
    </style>
    <!-- Chosen Palette: "Eighty760" App Theme (Light Mode) -->
    <!-- Structure: Same as before, but styled to look like the Streamlit app -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "TechArticle",
            "headline": "Eighty760 | 24/7 CFE Simulation Framework",
            "description": "Eighty760's always-on CFE simulation framework whitepaper covering methodology, architecture, and performance benchmarks for real-time financial risk analysis.",
            "inLanguage": "en",
            "author": {
                "@type": "Organization",
                "name": "Eighty760"
            },
            "publisher": {
                "@type": "Organization",
                "name": "Eighty760",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://eighty760.com/image.png"
                }
            },
            "url": "https://eighty760.com/whitepaper",
            "image": "https://eighty760.com/image.png",
            "about": "24/7 CFE simulation framework and digital twin methodology for real-time financial risk analysis",
            "keywords": ["CFE simulation", "always-on simulator", "financial risk", "digital twin", "Monte Carlo", "streaming analytics"]
        }
    </script>
</head>
<body class="antialiased">

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-24">
                <div class="flex items-center gap-3">
                    <!-- CHANGED: Switched from 'image.jpg' back to the repo's 'logo.png' -->
                    <img src="image.png" alt="Eighty760 Logo" class="h-24 w-auto object-contain">
                    <!-- REMOVED: Span with text "Eighty760 Simulator" was here -->
                </div>
                <div class="hidden sm:flex items-center space-x-8">
                    <a href="#simulator" class="text-gray-600 hover:text-[#285477] font-medium transition">Simulation</a>
                    <a href="#methodology" class="text-gray-600 hover:text-[#285477] font-medium transition">Methodology</a>
                    <a href="#architecture" class="text-gray-600 hover:text-[#285477] font-medium transition">Architecture</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="bg-white pt-16 pb-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div class="inline-flex items-center px-3 py-1 rounded-md bg-[#F5F5F5] text-[#666666] text-xs font-semibold uppercase tracking-wide mb-4 border border-gray-200">
                Technical Whitepaper V1.0
            </div>
            <h1 class="text-4xl sm:text-5xl font-extrabold brand-text mb-6 leading-tight">
                A Framework for <br class="hidden sm:block" />
                24/7 Carbon-Free Energy
            </h1>
            <p class="text-lg text-gray-600 mb-8 max-w-2xl mx-auto leading-relaxed">
                Moving beyond annual "Net Zero" accounting to hourly matching. Eighty760 is a simulation engine designed to model, analyze, and optimize energy portfolios against the rigorous standard of meeting demand with carbon-free energy every hour of the day.
            </p>
            <div class="flex justify-center gap-4">
                <button onclick="document.getElementById('simulator').scrollIntoView({behavior: 'smooth'})" class="btn-primary px-8 py-3 text-lg shadow-sm">
                    Launch Interactive Demo
                </button>
            </div>
        </div>
    </header>

    <!-- The Problem (Context) -->
    <section class="py-12 bg-white border-y border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid md:grid-cols-2 gap-12 items-center">
                <div>
                    <h2 class="text-2xl font-bold brand-text mb-4">The Challenge: Variability</h2>
                    <p class="text-gray-600 mb-4">
                        Renewable energy sources like wind and solar are inherently variable. A solar farm generates peak energy at midday, often creating a surplus, while failing to address demand during evening peaks or winter mornings.
                    </p>
                    <p class="text-gray-600 font-medium">
                        Eighty760 functions as a "digital twin," allowing users to simulate the complex interaction between load profiles and generation assets.
                    </p>
                </div>
                <div class="bg-[#F5F5F5] p-6 rounded-lg">
                    <h3 class="stMetricLabel mb-3">Traditional vs. 24/7 Matching</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-white rounded border border-gray-200">
                            <div>
                                <div class="font-bold text-gray-800">Annual Net Zero</div>
                                <div class="text-xs text-gray-500">Offsets fossil use via annual volume</div>
                            </div>
                            <div class="font-bold text-gray-400">~100% Volumetric</div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded border-l-4 border-[#285477] shadow-sm">
                            <div>
                                <div class="font-bold text-[#285477]">24/7 CFE</div>
                                <div class="text-xs text-gray-500">Matches supply & demand hourly</div>
                            </div>
                            <div class="font-bold text-[#285477]">Hourly Score</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Interactive Simulator Section -->
    <section id="simulator" class="py-16 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="mb-10 text-center">
                <h2 class="text-3xl font-bold brand-text">Interactive Portfolio Simulator</h2>
                <p class="text-gray-600 mt-2 max-w-2xl mx-auto">
                    Experience the <strong>Methodology</strong> described in the whitepaper. Adjust the generation capacities below to see how they stack up against a typical Office building load profile.
                </p>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Controls -->
                <div class="bg-[#F5F5F5] p-6 rounded-lg lg:col-span-1">
                    <h3 class="text-lg font-bold brand-text mb-6 flex items-center gap-2">
                        <span>üéõÔ∏è</span> Portfolio Inputs
                    </h3>
                    
                    <div class="space-y-8">
                        <!-- Solar Control -->
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-semibold text-gray-700">Solar Capacity</label>
                                <span id="solar-val" class="text-sm font-mono text-[#285477] bg-white px-2 py-1 rounded border border-gray-200">50 MW</span>
                            </div>
                            <input type="range" id="solar-input" min="0" max="200" value="50" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Modeled with midday bell curve (Methodology 3.1)</p>
                        </div>

                        <!-- Wind Control -->
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-semibold text-gray-700">Wind Capacity</label>
                                <span id="wind-val" class="text-sm font-mono text-[#285477] bg-white px-2 py-1 rounded border border-gray-200">30 MW</span>
                            </div>
                            <input type="range" id="wind-input" min="0" max="200" value="30" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Modeled with inverse-day variability</p>
                        </div>

                        <!-- Battery Control -->
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-semibold text-gray-700">Battery Storage</label>
                                <span id="battery-val" class="text-sm font-mono text-[#285477] bg-white px-2 py-1 rounded border border-gray-200">0 MWh</span>
                            </div>
                            <input type="range" id="battery-input" min="0" max="500" value="0" step="10" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Greedy dispatch algorithm</p>
                        </div>
                    </div>
                </div>

                <!-- Visualization -->
                <div class="bg-white p-6 rounded-lg border border-gray-200 lg:col-span-2 flex flex-col shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">24-Hour Generation Profile</h3>
                        <div class="flex gap-4 text-xs">
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-gray-800 rounded-full"></div> Load</div>
                            <!-- CHANGED: Reverted to the darker Amber/Yellow (#F59E0B) for better visibility without borders -->
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#F59E0B] rounded-full"></div> Solar</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#6699CC] rounded-full"></div> Wind</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#A3C2E0] rounded-full"></div> Battery</div>
                        </div>
                    </div>
                    
                    <div class="flex-grow flex items-center justify-center bg-white rounded-lg p-2">
                        <div class="chart-container">
                            <canvas id="simChart"></canvas>
                        </div>
                    </div>

                    <!-- KPIs -->
                    <div class="grid grid-cols-3 gap-4 mt-6">
                        <div class="stMetric text-center">
                            <div class="stMetricLabel mb-1">CFE Score</div>
                            <div id="cfe-score" class="stMetricValue">0%</div>
                            <div class="text-xs text-gray-500 mt-1">Hourly Match</div>
                        </div>
                        <div class="stMetric text-center">
                            <div class="stMetricLabel mb-1">Grid Needed</div>
                            <div id="grid-needed" class="stMetricValue">0</div>
                            <div class="text-xs text-gray-500 mt-1">MWh Deficit</div>
                        </div>
                        <div class="stMetric text-center">
                            <div class="stMetricLabel mb-1">Overgeneration</div>
                            <div id="over-gen" class="stMetricValue">0</div>
                            <div class="text-xs text-gray-500 mt-1">MWh Surplus</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Methodology Deep Dives -->
    <section id="methodology" class="py-16 bg-[#FAFAFA] border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold brand-text mb-8">Methodology & Logic</h2>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- 3.1 Generation Modeling -->
                <div class="bg-white p-6 rounded-lg border border-gray-200 hover:shadow-md transition">
                    <div class="w-10 h-10 bg-[#E3F2FD] rounded-md flex items-center justify-center mb-4 text-xl">‚òÄÔ∏è</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Generation Modeling</h3>
                    <p class="text-gray-600 text-sm mb-4">
                        Synthetic profiles replace missing historical data. Solar uses bell curves adjusted for seasonality.
                    </p>
                    <div class="bg-[#F5F5F5] p-3 rounded text-xs text-gray-500 font-mono">
                        Seasonality = 1 + 0.4 * cos(day - peak)
                    </div>
                </div>

                <!-- 3.3 Emissions Analysis -->
                <div class="bg-white p-6 rounded-lg border border-gray-200 hover:shadow-md transition">
                    <div class="w-10 h-10 bg-[#E3F2FD] rounded-md flex items-center justify-center mb-4 text-xl">üå´Ô∏è</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Emissions Analysis</h3>
                    <p class="text-gray-600 text-sm mb-4">
                        Calculates three distinct carbon metrics to ensure true abatement, not just paper offsets.
                    </p>
                    <ul class="text-sm space-y-2 text-gray-600">
                        <!-- CHANGED: Generalized the "Factor" label to be accurate for both modes -->
                        <li><strong>Location-Based:</strong> Total Load √ó Grid Intensity Factor</li>
                        <li><strong>Market-Based:</strong> Unmatched Load √ó Grid Intensity Factor</li>
                        <li><strong>Avoided:</strong> Renewable Gen √ó Grid Intensity Factor</li>
                    </ul>
                    <!-- ADDED: Clarification note about the switch -->
                    <p class="text-xs text-gray-400 mt-3 italic border-t border-gray-100 pt-2">
                        *The "Grid Intensity Factor" switches between <strong>Hourly Data</strong> and <strong>Annual Averages</strong> depending on the data source selected.
                    </p>
                </div>

                <!-- 3.4 Scarcity Pricing -->
                <div class="bg-white p-6 rounded-lg border border-gray-200 hover:shadow-md transition lg:col-span-1 md:col-span-2">
                    <div class="w-10 h-10 bg-[#E3F2FD] rounded-md flex items-center justify-center mb-4 text-xl">üí≤</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Scarcity Pricing Model</h3>
                    <p class="text-gray-600 text-sm mb-4">
                        REC values scale based on grid stress.
                    </p>
                    <div class="h-32 w-full">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Architecture Section -->
    <section id="architecture" class="py-16 bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold brand-text mb-8 text-center">System Architecture</h2>
            
            <div class="grid md:grid-cols-4 gap-4 text-center items-stretch">
                <!-- Input Layer -->
                <div class="bg-[#F5F5F5] p-6 rounded-lg border border-gray-200">
                    <h4 class="font-bold text-gray-800 mb-2">Input Layer</h4>
                    <p class="text-xs text-gray-500">Streamlit UI</p>
                </div>

                <!-- Arrow -->
                <div class="hidden md:flex items-center justify-center text-gray-300 text-2xl">‚ûù</div>

                <!-- Simulation Engine -->
                <div class="bg-[#F5F5F5] p-6 rounded-lg border border-gray-200 md:col-span-1">
                    <h4 class="font-bold text-gray-800 mb-2">Simulation Engine</h4>
                    <p class="text-xs text-gray-500">Python (Pandas/NumPy)</p>
                </div>

                 <!-- Arrow -->
                 <div class="hidden md:flex items-center justify-center text-gray-300 text-2xl">‚ûù</div>

                 <!-- Output Layer -->
                 <div class="bg-[#F5F5F5] p-6 rounded-lg border border-gray-200">
                    <h4 class="font-bold text-gray-800 mb-2">Visualization</h4>
                    <p class="text-xs text-gray-500">Altair / Streamlit</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-12 text-gray-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-2xl font-bold mb-4 brand-text">Eighty760</h3>
                    <p class="text-sm max-w-sm">
                        Enabling energy buyers and developers to design portfolios that achieve true decarbonization through hourly matching logic.
                    </p>
                </div>
                <div class="md:text-right">
                    <p class="text-sm">Based on Technical Whitepaper Version 1.0</p>
                    <p class="text-sm mt-2">¬© 2025 Eighty760 Simulation Framework</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // --- 1. Simulation Data Logic (Synthetic Generation) ---
        const HOURS = Array.from({length: 24}, (_, i) => i);
        
        // Simplified Load Profile (Office: low night, high day)
        const BASE_LOAD_PROFILE = [
            10, 10, 10, 10, 15, 25, 45, 65, 80, 85, 85, 80, 
            80, 85, 85, 80, 65, 45, 25, 20, 15, 10, 10, 10
        ];

        // Solar Bell Curve (0 at night, peak at noon)
        const SOLAR_PROFILE = HOURS.map(h => {
            if (h < 6 || h > 18) return 0;
            return Math.sin(((h - 6) * Math.PI) / 12); // 0 to 1
        });

        // Wind Profile (Inverse day for variability demo)
        const WIND_PROFILE = HOURS.map(h => {
            // Higher at night, dip during day
            return 0.5 + 0.3 * Math.cos(((h - 4) * Math.PI) / 12); 
        });

        // --- 2. State Management ---
        const state = {
            solarCap: 50,
            windCap: 30,
            batteryCap: 0,
            loadData: BASE_LOAD_PROFILE.map(l => l), // Copy
            genData: [],
            batteryOutput: new Array(24).fill(0),
            gridImport: [],
            overGen: []
        };

        // --- 3. Chart Initialization ---
        let simChart, finChart;

        function initCharts() {
            // Main Simulation Chart
            const ctxSim = document.getElementById('simChart').getContext('2d');
            simChart = new Chart(ctxSim, {
                type: 'line',
                data: {
                    labels: HOURS.map(h => `${h}:00`),
                    datasets: [
                        {
                            label: 'Load (MW)',
                            data: state.loadData,
                            borderColor: '#333333', // Dark Gray
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0.4,
                            order: 1
                        },
                        {
                            label: 'Solar Gen',
                            data: [],
                            // CHANGED: Reverted to Amber (#F59E0B). Removed the thick border and high opacity.
                            backgroundColor: 'rgba(245, 158, 11, 0.4)', // Amber 500 Transparent
                            borderColor: '#F59E0B', // Amber 500
                            borderWidth: 0,
                            fill: 'origin',
                            pointRadius: 0,
                            tension: 0.4,
                            order: 3
                        },
                        {
                            label: 'Wind Gen',
                            data: [],
                            backgroundColor: 'rgba(102, 153, 204, 0.4)', // Lighter Blue
                            borderColor: '#6699CC',
                            borderWidth: 0,
                            fill: '-1', // Stack on Solar
                            pointRadius: 0,
                            tension: 0.4,
                            order: 2
                        },
                        {
                            label: 'Battery Discharge',
                            data: [],
                            backgroundColor: 'rgba(163, 194, 224, 0.6)', // Very Light Blue
                            borderColor: '#A3C2E0',
                            borderWidth: 0,
                            fill: '-1', // Stack on Wind
                            pointRadius: 0,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + Math.round(context.raw) + ' MW';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Megawatts (MW)' },
                            stacked: false // Load is separate
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Financial Scarcity Chart (Methodology Section)
            const ctxFin = document.getElementById('financialChart').getContext('2d');
            finChart = new Chart(ctxFin, {
                type: 'bar',
                data: {
                    labels: ['Mid-Day (Abundant)', 'Shoulder', 'Evening Peak', 'Critical Winter'],
                    datasets: [{
                        label: 'REC Multiplier',
                        data: [0.45, 1.0, 1.2, 2.0],
                        backgroundColor: [
                            '#E3F2FD', 
                            '#BBDEFB',
                            '#64B5F6',
                            '#285477' // Darkest for Critical
                        ],
                        borderColor: 'transparent',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false, min: 0, max: 2.5 },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        // --- 4. Calculation Logic (The "Engine" in JS) ---
        function runSimulation() {
            // 1. Calculate Raw Generation
            const solarGen = SOLAR_PROFILE.map(v => v * state.solarCap);
            const windGen = WIND_PROFILE.map(v => v * state.windCap);
            
            // 2. Battery Logic (Greedy Dispatch)
            // Start with empty battery for simulation 
            let currentCharge = 0; 
            const BATTERY_EFFICIENCY = 0.85;
            
            const batteryDischargeProfile = [];
            const batteryChargeProfile = []; // For internal accounting
            
            // First pass: Calculate Surplus/Deficit
            // Simplified: We assume starting charge is 0 for this 24h slice loop
            // In a real 8760, this carries over. Here we just show the concept.
            
            // Let's pre-fill battery to 50% so we can see discharge early morning if needed
            currentCharge = state.batteryCap * 0.5;

            for (let i = 0; i < 24; i++) {
                const totalRenewable = solarGen[i] + windGen[i];
                const load = state.loadData[i];
                const net = totalRenewable - load;
                
                let discharged = 0;
                let charged = 0;

                if (net > 0) {
                    // Surplus -> Charge
                    const space = state.batteryCap - currentCharge;
                    charged = Math.min(net, space);
                    currentCharge += charged * BATTERY_EFFICIENCY;
                } else if (net < 0) {
                    // Deficit -> Discharge
                    const deficit = Math.abs(net);
                    // Discharging is limited by current charge and efficiency
                    // If we need 10 MW output, we drain 10 / eff from battery? 
                    // Usually efficiency is applied on R/T. Let's simplify: 
                    // Input * eff = stored. Output = stored. 
                    // Whitepaper says "Apply round-trip efficiency".
                    
                    const maxOutput = currentCharge; // Simple
                    discharged = Math.min(deficit, maxOutput);
                    currentCharge -= discharged;
                }
                
                batteryDischargeProfile.push(discharged);
            }

            // 3. KPI Calculation
            let totalLoad = 0;
            let totalMatched = 0;
            let totalOver = 0;
            let totalGrid = 0;

            for (let i = 0; i < 24; i++) {
                const load = state.loadData[i];
                const gen = solarGen[i] + windGen[i] + batteryDischargeProfile[i];
                
                totalLoad += load;
                
                // Match is min(gen, load)
                const match = Math.min(gen, load);
                totalMatched += match;
                
                // Overgeneration
                if (gen > load) totalOver += (gen - load);
                
                // Grid Needed
                if (gen < load) totalGrid += (load - gen);
            }

            // Update State
            state.genData = { solar: solarGen, wind: windGen, battery: batteryDischargeProfile };
            
            // Update UI Numbers
            const cfeScore = totalLoad > 0 ? (totalMatched / totalLoad) * 100 : 0;
            document.getElementById('cfe-score').innerText = cfeScore.toFixed(1) + '%';
            document.getElementById('grid-needed').innerText = Math.round(totalGrid).toLocaleString(); // Removed ' MWh'
            document.getElementById('over-gen').innerText = Math.round(totalOver).toLocaleString(); // Removed ' MWh'

            // Update Chart
            updateChart();
        }

        function updateChart() {
            if (!simChart) return;
            
            simChart.data.datasets[1].data = state.genData.solar;
            simChart.data.datasets[2].data = state.genData.wind;
            simChart.data.datasets[3].data = state.genData.battery;
            simChart.update();
        }

        // --- 5. Event Listeners ---
        function setupListeners() {
            const sInput = document.getElementById('solar-input');
            const wInput = document.getElementById('wind-input');
            const bInput = document.getElementById('battery-input');
            
            const handleUpdate = () => {
                state.solarCap = parseInt(sInput.value);
                state.windCap = parseInt(wInput.value);
                state.batteryCap = parseInt(bInput.value);
                
                document.getElementById('solar-val').innerText = state.solarCap + ' MW';
                document.getElementById('wind-val').innerText = state.windCap + ' MW';
                document.getElementById('battery-val').innerText = state.batteryCap + ' MWh';
                
                runSimulation();
            };

            sInput.addEventListener('input', handleUpdate);
            wInput.addEventListener('input', handleUpdate);
            bInput.addEventListener('input', handleUpdate);
        }

        // --- Initialization ---
        window.addEventListener('load', () => {
            initCharts();
            setupListeners();
            runSimulation(); // Initial run
        });

    </script>
</body>
</html>